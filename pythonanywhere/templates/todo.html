<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#2c2c2c" />
  <title>Future Notes</title>
  <link rel="apple-touch-icon" sizes="180x180" href="static/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="static/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="static/favicon-16x16.png" />
  <link rel="favicon" type="image/x-icon" href="static/favicon.ico" />
  <link rel="manifest" href="static/site.webmanifest">

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: #e0e0e0;
    }

    header {
        background-color: var(--hdr-color);
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .desktop-nav {
      display: flex;
      gap: 20px;
      margin: 0 auto; /* This centers the nav container */
    }


    header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
      color: #f2f2f2;
    }
    nav {
      display: flex;
      gap: 20px;
    }
    nav a {
      text-decoration: none;
    }
    .nav-link {
        position: relative;
        color: white;
        font-size: 18px;
        padding: 5px 0;
        transition: all 0.3s ease;
    }
    .nav-link::after {
      content: "";
      display: block;
      height: 2px;
      width: 0;
      background-color: transparent;
      transition: width 0.3s ease, background-color 0.3s ease;
    }
    .nav-link:hover::after {
      width: 100%;
      background-color: lightgray;
    }
    .nav-link.active::after {
      width: 100%;
      background-color: white;
    }
    .homepage-link {
      text-decoration: none;
      background-color: var(--ctr-color);
      color: #e0e0e0;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
    }
    header a:hover {
      background-color: #5c5c5c;
    }
    /* Mobile Sub-Header - Hidden by default */
    .mobile-sub-header {
      display: none;
      background-color: var(--hdr-color);
      padding: 10px 0;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* Mobile Nav Links */
    .mobile-sub-header a {
      display: block;
      color: white;
      text-decoration: none;
      padding: 10px;
      font-size: 18px;
    }

    /* Active State */
    .mobile-sub-header a.active::after {
      content: "";
      display: block;
      height: 2px;
      width: 100%;
      background-color: white;
    }

    /* Hover effect */
    .mobile-sub-header a:hover::after {
      background-color: lightgray;
    }
    .profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--hdr-color);
        color: #e0e0e0;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
        background-size: cover;
        background-position: center;
    }
    .profile-pic.no-picture {
        background-color: #cc4f4f; /* Soft blue background when no picture */
        color: white; /* White text for the initial */
        border-radius: 50%;
    }

     #floating-add-button {
      display: flex;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background-color: var(--btn-color);
      color: #e0e0e0;
      border-radius: 50%;
      justify-content: center;
      align-items: center;
      font-size: 30px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s ease;
      z-index: 1000;
    }
    #floating-add-button:hover {
      background-color: #7a7a7a;
    }

    /* Modal Overlay */
    #todo-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    #todo-modal {
      background: var(--bg-color);
      border-radius: 8px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    #todo-modal h2 {
      margin-top: 0;
    }
    #todo-modal form {
      display: flex;
      flex-direction: column;
    }
    #todo-modal label {
      margin: 10px 0 5px;
    }
    #todo-modal input,
    #todo-modal textarea {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: var(--btn-color);
    }
    #todo-modal .actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }
    #todo-modal button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      background-color: var(--btn-color);
      color: white;
    }
    #todo-modal button.cancel {
      background: #ccc;
      margin-right: 10px;
    }

    /* Toggle Button - hidden by default */
    .toggle-mobile-nav {
    background: none;
    border: none;
    color: #f2f2f2;
    font-size: 24px;
    cursor: pointer;
    display: none; /* Hidden by default */
    margin-right: 10px;
    }
    .toggle-mobile-nav:hover {
      background-color: none;
    }
    /* Desktop Nav - Visible on large screens */
    .desktop-nav {
      display: flex;
      gap: 20px;
    }
    /* Responsive Styles */
    @media (max-width: 600px) {
      .desktop-nav {
        display: none;
      }
      .toggle-mobile-nav {
        display: block;
      }
      header a {
        display: none;
      }
    }
    /* Root variables from your default colors */
    #todo-overview-container {
      background-color: var(--bg-color);
      padding: 20px;
      border-radius: 8px;
      max-width: 800px;
      margin: 20px auto;
    }
    #todo-overview-container h2 {
      color: var(--hdr-color);
      margin-bottom: 16px;
      font-size: 24px;
    }
    .todo-card {
      background-color: var(--btn-color);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .todo-title {
      color: var(--ctr-color);
      font-size: 20px;
      font-weight: 600;
    }
    .todo-text {
      color: #e0e0e0;
      font-size: 16px;
    }
    .todo-due {
      font-size: 14px;
      font-weight: 500;
      align-self: flex-end;
      padding: 4px 8px;
      border-radius: 4px;
      background-color: rgba(255, 255, 255, 0.1);
      transition: background-color 0.3s ease;
    }
    .todo-due.near {
      background-color: #d9534f; /* matching your palette */
      color: #fff;
    }
  </style>
  <script src="static/admin.js"></script>

  <style>
        :root {
          --bg-color:  #2c2c2c;  /* defaults */
          --hdr-color: #3a3a3a;
          --ctr-color: #1e1e1e;
          --btn-color: #424242;
        }
      </style>
    
      <script>
        // one‑time injection of all four colors
        window.appConfig = {
          backgroundColor: "{{ bg_color }}",
          headerColor:     "{{ hdr_color }}",
          contrastingColor:"{{ ctr_color }}",
          buttonColor:     "{{ btn_color }}"
        };
      </script>

<header>
    <!-- Toggle button (only visible on mobile) -->
    <button id="toggle-mobile-nav" class="toggle-mobile-nav">☰</button>
    
    <a href="/" class="homepage-link"><h1>Future Notes</h1></a>
    
    <nav class="desktop-nav">
      <a href="/index" class="nav-link">Personal notes</a>
      <a href="/group-notes" class="nav-link">Group notes</a>
      <a href="/scheduler-page" class="nav-link">Calendar</a>
      <a href="/todo-page" class="nav-link active">Todo</a>
    </nav>
    
    <div id="profile-pic" class="profile-pic no-picture"></div>
  </header>
  
  <!-- Mobile Sub-Header -->
  <nav id="mobileSubHeader" class="mobile-sub-header">
    <a href="/index" class="nav-link">Personal notes</a>
    <a href="/group-notes" class="nav-link">Group notes</a>
    <a href="/scheduler-page" class="nav-link">Calendar</a>
    <a href="/todo-page" class="nav-link active">Todo</a>
  </nav>  

  <div id="overlay"></div>

  <div id="todo-overview-container">
    <h2>Your Todos</h2>
    <div id="todo-list"></div>
  </div>

  <div id="floating-add-button">+</div>

  <div id="todo-modal-overlay">
    <div id="todo-modal">
      <h2 id="modal-title">Add Todo</h2>
      <form id="todo-form">
        <input type="hidden" id="todo-id">
        <label for="todo-title">Title</label>
        <input type="text" id="todo-title" required>

        <label for="todo-due">Due Date</label>
        <input type="datetime-local" id="todo-due">

        <label for="todo-desc">Description</label>
        <textarea id="todo-desc" rows="3"></textarea>

        <div class="actions">
          <button type="button" class="cancel">Cancel</button>
          <button type="submit" id="submit-button">Add</button>
          <button type="button" id="delete-button" style="display: none;">Delete</button>
        </div>
      </form>
    </div>
  </div>
<script>
// ======== Authentication & Existing Logic =========
    // globaly define sessionKey
    document.addEventListener("DOMContentLoaded", async () => {
      const sessionKey = sessionStorage.getItem("session_key");
      const lastingKey = localStorage.getItem("lasting_key");

      async function attemptAutoLogin() {
        try {
          const response = await fetch("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lasting_key: lastingKey }),
          });
          const data = await response.json();
          if (response.ok) {
            sessionStorage.setItem("session_key", data.session_key);
            console.log("Auto-login successful!");
          } else {
            console.error("Auto-login failed:", data.error || "Unknown error");
            localStorage.removeItem("lasting_key");
            showModal();
          }
        } catch (error) {
          console.error("Error during auto-login:", error);
          showModal();
        }
      }

      if (!sessionStorage.getItem("session_key") && lastingKey) {
        await attemptAutoLogin();
      } else if (!sessionStorage.getItem("session_key") && !lastingKey) {
        showModal();
      } else {
        try {
          const response = await fetch("/test-session", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${sessionStorage.getItem("session_key")}`,
            },
          });
          if (response.status === 401) {
            if (lastingKey) {
              await attemptAutoLogin();
            } else {
              showModal();
            }
          } else {
            hideModal();
          }
        } catch (error) {
          console.error("Error during session validation:", error);
          showModal();
        }
      }
      fetchTodos();
    });

    const addBtn = document.getElementById('floating-add-button');
    const overlay = document.getElementById('todo-modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const form = document.getElementById('todo-form');
    const submitBtn = document.getElementById('submit-button');
    const cancelBtn = document.querySelector('#todo-modal .cancel');
    const deleteBtn = document.getElementById('delete-button');

    // Open modal in add or edit mode
    function openModal(mode, data = {}) {
      overlay.style.display = 'flex';
      modalTitle.textContent = mode === 'add' ? 'Add Todo' : 'Edit Todo';
      submitBtn.textContent = mode === 'add' ? 'Add' : 'Save';

      // Prefill fields
      document.getElementById('todo-id').value = data.id || '';
      document.getElementById('todo-title').value = data.title || '';
      document.getElementById('todo-due').value = data.due ? data.due.substring(0,16) : '';
      document.getElementById('todo-desc').value = data.description || '';

      // Toggle delete button only in edit mode
      if (mode === 'edit') {
        deleteBtn.style.display = 'inline-block';
        // store the current id on the button so we can use it in the handler:
        deleteBtn.dataset.id = data.id;
      } else {
        deleteBtn.style.display = 'none';
        deleteBtn.dataset.id = '';
      }

      form.onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
          title: document.getElementById('todo-title').value,
          due_date: document.getElementById('todo-due').value,
          description: document.getElementById('todo-desc').value
        };
        let url = '/todos';
        if (mode === 'edit') {
          url = `/todos/${data.id}`;
        }
        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${sessionStorage.getItem("session_key")}`
            },
            body: JSON.stringify(payload)
          });
          if (res.ok) {
            location.reload();
          } else {
            console.error('Error saving todo');
          }
        } catch (err) {
          console.error('Network error', err);
        }
      };
    }

    function closeModal() {
      overlay.style.display = 'none';
    }

    // Event: Add button click
    addBtn.addEventListener('click', () => openModal('add'));
    cancelBtn.addEventListener('click', closeModal);

    deleteBtn.addEventListener('click', async () => {
      const todoId = deleteBtn.dataset.id;
      if (!todoId) return;

      if (!confirm('Are you sure you want to delete this todo?')) {
        return;
      }

      try {
        const res = await fetch(`/todos/${todoId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${sessionStorage.getItem("session_key")}`
          }
        });
        if (res.ok) {
          closeModal();
          // you can either reload the page:
          // location.reload();
          // or re-fetch and re-render just the list:
          fetchTodos();
        } else {
          console.error('Error deleting todo');
        }
      } catch (err) {
        console.error('Network error deleting todo', err);
      }
    });


    // Event: Clicking a todo item
    document.getElementById('todo-list').addEventListener('click', e => {
      // Find the nearest .todo-card
      const card = e.target.closest('.todo-card');
      if (!card) return;

      openModal('edit', {
        id:          card.dataset.id,
        title:       card.dataset.title,
        due:         card.dataset.due,
        description: card.dataset.description
      });
    });


    function showModal() {

    }
    function hideModal() {
      // No action needed; placeholder function
    }
    document.addEventListener("DOMContentLoaded", function() {
      const toggleButton = document.getElementById("toggle-mobile-nav");
      const mobileNav = document.getElementById("mobileSubHeader");

      toggleButton.addEventListener("click", function() {
        // Toggle between showing and hiding the mobile nav
        if (mobileNav.style.display === "block") {
          mobileNav.style.display = "none";
        } else {
          mobileNav.style.display = "block";
        }
      });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const cfg = window.appConfig || {};

        // store in a JS var if you need it elsewhere
        const userColors = {
            bg:  cfg.backgroundColor,
            hdr: cfg.headerColor,
            ctr: cfg.contrastingColor,
            btn: cfg.buttonColor
        };

        // apply each to the CSS custom properties
        const root = document.documentElement;
        root.style.setProperty("--bg-color",  userColors.bg);
        root.style.setProperty("--hdr-color", userColors.hdr);
        root.style.setProperty("--ctr-color", userColors.ctr);
        root.style.setProperty("--btn-color", userColors.btn);

        // now your CSS (using var(--bg-color), etc.) will reflect the user’s choices
        });
    window.onload = async () => {
      const sessionKey = sessionStorage.getItem("session_key");
      if (!sessionKey) {
        showModal();
        return;
      }
      try {
        const response = await fetch("/test-session", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${sessionStorage.getItem("session_key")}`,
          },
        });
        if (response.status === 401) {
          showModal();
        } else {
          const userInfoResponse = await fetch("/user-info", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${sessionStorage.getItem("session_key")}`,
            },
          });
          if (userInfoResponse.ok) {
            const userInfo = await userInfoResponse.json();
            const username = userInfo.username;
            const profilePic = userInfo.profile_picture;
            const profilePicElement = document.getElementById("profile-pic");
            if (profilePic) {
              const correctedProfilePic = profilePic.replace(/\\/g, "/");
              profilePicElement.style.backgroundImage = `url(${correctedProfilePic})`;
              profilePicElement.classList.remove("no-picture");
              profilePicElement.textContent = "";
            } else {
              profilePicElement.textContent = username[0].toUpperCase();
              profilePicElement.classList.add("no-picture");
            }
          } else {
            console.error("Failed to fetch user info");
          }
        }
      } catch (error) {
        console.error("Error during re-login:", error);
      }
    };
    document.getElementById("profile-pic").addEventListener("click", showAccountMenu);
    function showAccountMenu() {
      window.location.href = "/account_page";
    }
    sessionStorage.setItem("last_page", "/todo_page");

    // Async function to fetch and render todos
    async function fetchTodos() {
      const sessionKey = sessionStorage.getItem("session_key");
      const listEl = document.getElementById('todo-list');
      listEl.innerHTML = ''; // Clear existing
      const now = new Date();
      try {
        const res = await fetch('/todos', {
          headers: {
            'Authorization': `Bearer ${sessionKey}`
          }
        });
        const data = await res.json();
        if (!data.todos) {
          listEl.textContent = 'No todos available.';
          return;
        }
        data.todos.forEach(todo => {
          const dueDate = todo.due_date ? new Date(todo.due_date) : null;
          const card = document.createElement('div');
          card.className = 'todo-card';

            card.dataset.id          = todo.id;
            card.dataset.title       = todo.title;
            card.dataset.due         = todo.due_date || '';
            card.dataset.description = todo.text || '';

          const title = document.createElement('div');
          title.className = 'todo-title';
          title.textContent = todo.title;

          const text = document.createElement('div');
          text.className = 'todo-text';
          text.textContent = todo.text || '';

          card.appendChild(title);
          card.appendChild(text);

          if (dueDate) {
            const dueEl = document.createElement('div');
            dueEl.className = 'todo-due';
            const diffMs = dueDate - now;
            const diffDays = diffMs / (1000 * 60 * 60 * 24);
            dueEl.textContent = `Due: ${dueDate.toLocaleString()}`;
            if (diffDays <= 1) {
              dueEl.classList.add('near');
            }
            card.appendChild(dueEl);
          }
          listEl.appendChild(card);
        });
      } catch (err) {
        console.error('Error fetching todos:', err);
        listEl.textContent = 'Failed to load todos.';
      }
    }

    // Expose fetchTodos to global scope for auth logic to call
    window.fetchTodos = fetchTodos;
</script>